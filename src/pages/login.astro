---
// ç§»é™¤Headerå’ŒFooterå¯¼å…¥
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>ç™»å½• - B-Market æœåŠ¡å™¨ç®¡ç†å¹³å°</title>
	<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
	
	<!-- å…¨å±€APIé…ç½® - æ”¯æŒDockerç¯å¢ƒå˜é‡é…ç½® -->
	<script is:inline>
		window.API_CONFIG = {
			baseUrl: (() => {
				// 1. ä¼˜å…ˆä½¿ç”¨é¢„å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼ˆåœ¨æ„å»ºæ—¶æ³¨å…¥ï¼‰
				const envApiUrl = '{PUBLIC_API_BASE_URL}'; // æ„å»ºæ—¶ä¼šè¢«ç¯å¢ƒå˜é‡æ›¿æ¢
				if (envApiUrl && envApiUrl !== '{PUBLIC_API_BASE_URL}') {
					// loginé¡µé¢éœ€è¦åŸºç¡€URLï¼Œä¸åŒ…å«/apiè·¯å¾„
					return envApiUrl.replace('/api', '');
				}
				
				// 2. åŠ¨æ€æ£€æµ‹å½“å‰ç¯å¢ƒ
				if (typeof window !== 'undefined') {
					const currentHost = window.location.hostname;
					const currentProtocol = window.location.protocol;
					
					// ç”Ÿäº§ç¯å¢ƒæ£€æµ‹ï¼ˆéæœ¬åœ°å¼€å‘ï¼‰
					if (currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
						// åœ¨Dockerç¯å¢ƒä¸­ï¼Œå®¢æˆ·ç«¯åº”è¯¥é€šè¿‡åŒæ ·çš„åŸŸåå’Œç«¯å£è®¿é—®API
						return `${currentProtocol}//${currentHost}:3001`;
					}
				}
				
				// 3. å¼€å‘ç¯å¢ƒé»˜è®¤é…ç½®
				return 'http://localhost:3001';
			})()
		};
		console.log('ğŸ”— ç™»å½•é¡µé¢APIé…ç½®:', window.API_CONFIG.baseUrl);
	</script>
	
	<style>
		/* å…¨å±€æ ·å¼é‡ç½® */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		html {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
			line-height: 1.6;
		}
		
		/* ä½¿ç”¨ä¸adminé¡µé¢ç»Ÿä¸€çš„èƒŒæ™¯ */
		body {
			background: url('/background.svg') no-repeat center center fixed;
			background-size: cover;
			color: #1a1a1a;
			min-height: 100vh;
			position: relative;
		}
		
		body::before {
			content: '';
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
			z-index: -1;
		}
		
		/* é¡µé¢å®¹å™¨ */
		.login-wrapper {
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
			animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		@keyframes fadeIn {
			0% {
				opacity: 0;
				transform: translateY(20px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* ç™»å½•å¡ç‰‡ - ç®€çº¦æ‰å¹³åŒ–è®¾è®¡ */
		.login-card {
			background: rgba(255, 255, 255, 0.15);
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 16px;
			padding: 32px;
			width: 100%;
			max-width: 400px;
			backdrop-filter: blur(20px);
			-webkit-backdrop-filter: blur(20px);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			animation: cardSlideIn 0.6s 0.2s cubic-bezier(0.4, 0, 0.2, 1) both;
		}
		
		@keyframes cardSlideIn {
			0% {
				opacity: 0;
				transform: translateY(30px) scale(0.95);
			}
			100% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}
		
		/* Logoå’Œæ ‡é¢˜åŒºåŸŸ */
		.login-header {
			text-align: center;
			margin-bottom: 28px;
		}
		
		.login-logo {
			width: 48px;
			height: 48px;
			margin: 0 auto 16px auto;
			background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 24px;
			font-weight: 700;
			color: white;
		}
		
		.login-title {
			font-size: 1.375rem;
			font-weight: 600;
			color: #1f2937;
			margin-bottom: 6px;
		}
		
		.login-subtitle {
			color: #6b7280;
			font-size: 0.875rem;
			font-weight: 400;
		}
		
		/* è¡¨å•æ ·å¼ */
		.login-form {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
		
		.form-group {
			display: flex;
			flex-direction: column;
			gap: 0;
		}
		
		.form-label {
			display: none;
		}
		
		.form-input {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid rgba(209, 213, 219, 0.6);
			border-radius: 8px;
			font-size: 0.9375rem;
			background: rgba(255, 255, 255, 0.8);
			color: #374151;
			line-height: 1.5;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			box-sizing: border-box;
		}
		
		.form-input:focus {
			outline: none;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}
		
		.form-input::placeholder {
			color: #9ca3af;
		}
		
		/* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ - ç®€çº¦è®¾è®¡ */
		.password-strength {
			margin-top: 8px;
			padding: 12px;
			background: rgba(248, 250, 252, 0.8);
			border-radius: 6px;
			font-size: 0.75rem;
			display: none;
		}
		
		.password-strength.show {
			display: block;
		}
		
		.strength-item {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 4px;
		}
		
		.strength-item:last-child {
			margin-bottom: 0;
		}
		
		.strength-check {
			width: 14px;
			height: 14px;
			border-radius: 3px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 9px;
			color: white;
			font-weight: 600;
		}
		
		.strength-check.valid {
			background: #10b981;
		}
		
		.strength-check.invalid {
			background: #ef4444;
		}
		
		/* ç™»å½•æŒ‰é’® - ç®€çº¦æ‰å¹³åŒ– */
		.login-btn {
			width: 100%;
			padding: 14px 24px;
			background: #3b82f6;
			color: white;
			border: none;
			border-radius: 8px;
			font-size: 0.9375rem;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
			margin-top: 8px;
			box-sizing: border-box;
		}
		
		.login-btn:hover {
			background: #2563eb;
		}
		
		.login-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		
		.btn-text {
			transition: opacity 0.2s;
		}
		
		.btn-loading {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			opacity: 0;
			transition: opacity 0.2s;
		}
		
		.login-btn.loading .btn-text {
			opacity: 0;
		}
		
		.login-btn.loading .btn-loading {
			opacity: 1;
		}
		
		/* åŠ è½½åŠ¨ç”» */
		.spinner {
			width: 16px;
			height: 16px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-top: 2px solid white;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		
		/* æ¶ˆæ¯æç¤º - ä¼˜åŒ–è®¾è®¡ */
		.message {
			padding: 12px 16px;
			border-radius: 8px;
			font-size: 0.9375rem;
			font-weight: 500;
			margin-top: 16px;
			text-align: center;
			animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
		}
		
		@keyframes messageSlideIn {
			0% {
				opacity: 0;
				transform: translateY(-10px) scale(0.98);
			}
			100% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}
		
		.message.error {
			background: linear-gradient(135deg, rgba(254, 242, 242, 0.95) 0%, rgba(254, 242, 242, 0.9) 100%);
			color: #dc2626;
			border: 1px solid rgba(239, 68, 68, 0.3);
			box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
		}
		
		.message.success {
			background: linear-gradient(135deg, rgba(240, 253, 244, 0.95) 0%, rgba(236, 253, 245, 0.9) 100%);
			color: #047857;
			border: 1px solid rgba(34, 197, 94, 0.3);
			box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
		}
		
		.message.success::before {
			content: 'âœ“';
			position: absolute;
			left: 12px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 1rem;
			font-weight: 700;
			color: #10b981;
		}
		
		.message.success {
			padding-left: 36px;
		}
		
		/* è¿”å›é¦–é¡µé“¾æ¥ */
		.back-link {
			text-align: center;
			margin-top: 20px;
		}
		
		.back-link a {
			color: #6b7280;
			text-decoration: none;
			font-size: 0.875rem;
			font-weight: 400;
			transition: color 0.2s;
		}
		
		.back-link a:hover {
			color: #374151;
		}
		
		/* å“åº”å¼è®¾è®¡ */
		@media (max-width: 480px) {
			.login-wrapper {
				padding: 16px;
			}
			
			.login-card {
				padding: 24px;
			}
			
			.form-input {
				font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
			}
		}
		
		/* æ— éšœç¢æ”¯æŒ */
		@media (prefers-reduced-motion: reduce) {
			*,
			*::before,
			*::after {
				animation-duration: 0.01ms !important;
				animation-iteration-count: 1 !important;
				transition-duration: 0.01ms !important;
			}
		}
	</style>
</head>
<body>
	<div class="login-wrapper">
		<div class="login-card">
			<div class="login-header">
				<div class="login-logo">B</div>
				<h1 class="login-title" id="loginTitle">ç®¡ç†ç³»ç»Ÿç™»å½•</h1>
				<p class="login-subtitle" id="loginSubtitle">è¯·è¾“å…¥å¯†ç è®¿é—®ç®¡ç†æ§åˆ¶å°</p>
			</div>
			
			<form class="login-form" id="loginForm">
				<!-- é¦–æ¬¡è®¾ç½®å¯†ç çš„å­—æ®µ -->
				<div class="form-group" id="newPasswordGroup" style="display: none;">
					<label class="form-label" for="newPassword">è®¾ç½®å¯†ç </label>
					<input 
						type="password" 
						id="newPassword" 
						class="form-input" 
						placeholder="è¯·è®¾ç½®ç®¡ç†å¯†ç "
						autocomplete="new-password"
					>
					<div class="password-strength" id="passwordStrength">
						<div class="strength-item">
							<div class="strength-check invalid" id="lengthCheck">Ã—</div>
							<span>è‡³å°‘8ä½å­—ç¬¦</span>
						</div>
						<div class="strength-item">
							<div class="strength-check invalid" id="lowercaseCheck">Ã—</div>
							<span>åŒ…å«å°å†™å­—æ¯</span>
						</div>
						<div class="strength-item">
							<div class="strength-check invalid" id="uppercaseCheck">Ã—</div>
							<span>åŒ…å«å¤§å†™å­—æ¯</span>
						</div>
						<div class="strength-item">
							<div class="strength-check invalid" id="numberCheck">Ã—</div>
							<span>åŒ…å«æ•°å­—</span>
						</div>
						<div class="strength-item">
							<div class="strength-check invalid" id="specialCheck">Ã—</div>
							<span>åŒ…å«ç‰¹æ®Šå­—ç¬¦(@$!%*?&)</span>
						</div>
					</div>
				</div>
				
				<div class="form-group" id="confirmPasswordGroup" style="display: none;">
					<label class="form-label" for="confirmPassword">ç¡®è®¤å¯†ç </label>
					<input 
						type="password" 
						id="confirmPassword" 
						class="form-input" 
						placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
						autocomplete="new-password"
					>
				</div>
				
				<!-- ç™»å½•å¯†ç å­—æ®µ -->
				<div class="form-group" id="passwordGroup">
					<label class="form-label" for="password">ç®¡ç†å¯†ç </label>
					<input 
						type="password" 
						id="password" 
						class="form-input" 
						placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç "
						autocomplete="current-password"
					>
				</div>
				
				<button type="submit" class="login-btn" id="loginBtn">
					<span class="btn-text" id="btnText">ç™»å½•</span>
					<div class="btn-loading">
						<div class="spinner"></div>
					</div>
				</button>
				
				<div id="messageContainer"></div>
			</form>
			
			<div class="back-link">
				<a href="/">â† è¿”å›é¦–é¡µ</a>
			</div>
		</div>
	</div>

	<script is:inline>
		let isFirstLogin = false;
		let isLoading = false;

		// APIåŸºç¡€URL - Dockerå•å®¹å™¨åå‘ä»£ç†æ¨¡å¼
		const API_BASE_URL = (() => {
			const currentHost = window.location.hostname;
			if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
				// å¼€å‘ç¯å¢ƒç›´æ¥è®¿é—®APIç«¯å£
				return 'http://localhost:3001';
			} else {
				// ç”Ÿäº§ç¯å¢ƒï¼ˆDockerï¼‰ï¼šä½¿ç”¨åå‘ä»£ç†ï¼Œå»æ‰/apiåç¼€
				return '';
			}
		})();

		// é¡µé¢åˆå§‹åŒ–
		async function initLoginPage() {
			try {
				// æ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡ç™»å½•
				const response = await fetch(`${API_BASE_URL}/api/auth/check-first-login`);
				const result = await response.json();
				
				if (result.success) {
					isFirstLogin = result.isFirstLogin;
					updateUI();
				}
			} catch (error) {
				console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
				showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡å™¨çŠ¶æ€', 'error');
			}
		}

		// æ›´æ–°UIç•Œé¢
		function updateUI() {
			const title = document.getElementById('loginTitle');
			const subtitle = document.getElementById('loginSubtitle');
			const btnText = document.getElementById('btnText');
			const newPasswordGroup = document.getElementById('newPasswordGroup');
			const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
			const passwordGroup = document.getElementById('passwordGroup');

			if (isFirstLogin) {
				title.textContent = 'é¦–æ¬¡ä½¿ç”¨è®¾ç½®';
				subtitle.textContent = 'è¯·ä¸ºç®¡ç†ç³»ç»Ÿè®¾ç½®ä¸€ä¸ªå®‰å…¨å¯†ç ';
				btnText.textContent = 'å®Œæˆè®¾ç½®';
				
				// æ˜¾ç¤ºè®¾ç½®å¯†ç å­—æ®µ
				newPasswordGroup.style.display = 'block';
				confirmPasswordGroup.style.display = 'block';
				passwordGroup.style.display = 'none';
				
				// ç»‘å®šå¯†ç å¼ºåº¦æ£€æŸ¥
				const newPasswordInput = document.getElementById('newPassword');
				newPasswordInput.addEventListener('input', checkPasswordStrength);
				newPasswordInput.addEventListener('focus', () => {
					document.getElementById('passwordStrength').classList.add('show');
				});
			} else {
				title.textContent = 'ç®¡ç†ç³»ç»Ÿç™»å½•';
				subtitle.textContent = 'è¯·è¾“å…¥å¯†ç è®¿é—®ç®¡ç†æ§åˆ¶å°';
				btnText.textContent = 'ç™»å½•';
				
				// æ˜¾ç¤ºç™»å½•å­—æ®µ
				newPasswordGroup.style.display = 'none';
				confirmPasswordGroup.style.display = 'none';
				passwordGroup.style.display = 'block';
			}
		}

		// æ£€æŸ¥å¯†ç å¼ºåº¦
		function checkPasswordStrength() {
			const password = document.getElementById('newPassword').value;
			
			const checks = {
				length: password.length >= 8,
				lowercase: /[a-z]/.test(password),
				uppercase: /[A-Z]/.test(password),
				number: /\d/.test(password),
				special: /[@$!%*?&]/.test(password)
			};
			
			// æ›´æ–°æ£€æŸ¥é¡¹ç›®çŠ¶æ€
			Object.keys(checks).forEach(check => {
				const element = document.getElementById(check + 'Check');
				if (checks[check]) {
					element.className = 'strength-check valid';
					element.textContent = 'âœ“';
				} else {
					element.className = 'strength-check invalid';
					element.textContent = 'Ã—';
				}
			});
			
			return Object.values(checks).every(check => check);
		}

		// æ˜¾ç¤ºæ¶ˆæ¯
		function showMessage(message, type = 'error') {
			const container = document.getElementById('messageContainer');
			container.innerHTML = `<div class="message ${type}">${message}</div>`;
		}

		// æ¸…é™¤æ¶ˆæ¯
		function clearMessages() {
			const container = document.getElementById('messageContainer');
			container.innerHTML = '';
		}

		// è¡¨å•æäº¤å¤„ç†
		async function handleSubmit(event) {
			event.preventDefault();
			
			if (isLoading) return;
			
			const form = event.target;
			const loginBtn = document.getElementById('loginBtn');
			const btnText = document.getElementById('btnText');
			
			try {
				isLoading = true;
				loginBtn.classList.add('loading');
				loginBtn.disabled = true;
				
				clearMessages();
				
				if (isFirstLogin) {
					await handleFirstTimeSetup();
				} else {
					await handleLogin();
				}
			} catch (error) {
				console.error('å¤„ç†è¡¨å•æäº¤å¤±è´¥:', error);
				showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
				// æ¢å¤æŒ‰é’®æ–‡å­—
				if (isFirstLogin) {
					btnText.textContent = 'å®Œæˆè®¾ç½®';
				} else {
					btnText.textContent = 'ç™»å½•';
				}
			} finally {
				isLoading = false;
				loginBtn.classList.remove('loading');
				loginBtn.disabled = false;
			}
		}

		// å¤„ç†é¦–æ¬¡è®¾ç½®å¯†ç 
		async function handleFirstTimeSetup() {
			const newPassword = document.getElementById('newPassword').value;
			const confirmPassword = document.getElementById('confirmPassword').value;
			const btnText = document.getElementById('btnText');
			
			// éªŒè¯è¾“å…¥
			if (!newPassword || !confirmPassword) {
				showMessage('è¯·å¡«å†™å¯†ç å’Œç¡®è®¤å¯†ç ', 'error');
				return;
			}
			
			if (newPassword !== confirmPassword) {
				showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
				return;
			}
			
			if (!checkPasswordStrength()) {
				showMessage('å¯†ç ä¸ç¬¦åˆå®‰å…¨è¦æ±‚ï¼Œè¯·æ£€æŸ¥å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨', 'error');
				return;
			}
			
			// æ›´æ–°æŒ‰é’®æ–‡å­—ä¸º"è®¾ç½®ä¸­"
			btnText.textContent = 'è®¾ç½®ä¸­';
			
			// å‘é€è®¾ç½®å¯†ç è¯·æ±‚
			const response = await fetch(`${API_BASE_URL}/api/auth/setup-password`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				credentials: 'include',
				body: JSON.stringify({
					password: newPassword,
					confirmPassword: confirmPassword
				})
			});
			
			const result = await response.json();
			
			if (result.success) {
				// ä¿å­˜session token
				localStorage.setItem('sessionToken', result.sessionToken);
				
				// ç›´æ¥è·³è½¬åˆ°ç®¡ç†é¡µé¢ï¼Œä¸æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
				window.location.href = '/admin';
			} else {
				// æ¢å¤æŒ‰é’®æ–‡å­—
				btnText.textContent = 'å®Œæˆè®¾ç½®';
				showMessage(result.message || 'è®¾ç½®å¯†ç å¤±è´¥', 'error');
			}
		}

		// å¤„ç†ç™»å½•
		async function handleLogin() {
			const password = document.getElementById('password').value;
			const btnText = document.getElementById('btnText');
			
			if (!password) {
				showMessage('è¯·è¾“å…¥å¯†ç ', 'error');
				return;
			}
			
			// æ›´æ–°æŒ‰é’®æ–‡å­—ä¸º"ç™»å½•ä¸­"
			btnText.textContent = 'ç™»å½•ä¸­';
			
			// å‘é€ç™»å½•è¯·æ±‚
			const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				credentials: 'include',
				body: JSON.stringify({
					password: password
				})
			});
			
			const result = await response.json();
			
			if (result.success) {
				// ä¿å­˜session token
				localStorage.setItem('sessionToken', result.sessionToken);
				
				// ç›´æ¥è·³è½¬åˆ°ç®¡ç†é¡µé¢ï¼Œä¸æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
				window.location.href = '/admin';
			} else {
				// æ˜¾ç¤ºç™»å½•å¤±è´¥æŒ‰é’®çŠ¶æ€
				btnText.textContent = 'ç™»å½•å¤±è´¥';
				
				// 2ç§’åæ¢å¤æŒ‰é’®æ–‡å­—
				setTimeout(() => {
					btnText.textContent = 'ç™»å½•';
				}, 2000);
			}
		}

		// ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
		document.getElementById('loginForm').addEventListener('submit', handleSubmit);

		// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
		document.addEventListener('DOMContentLoaded', initLoginPage);
	</script>
</body>
</html> 