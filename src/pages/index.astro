---
import ServerCard from '../components/ServerCard.astro';
import Header from '../components/Header.jsx';
import Footer from '../components/Footer.jsx';

// è·å–APIåŸºç¡€URL - Dockerå•å®¹å™¨æ¨¡å¼
function getApiBaseUrl() {
  // åœ¨Dockerå•å®¹å™¨ç¯å¢ƒä¸­ï¼ŒAPIæœåŠ¡è¿è¡Œåœ¨localhost:3001
  // æœåŠ¡å™¨ç«¯å§‹ç»ˆä½¿ç”¨å†…éƒ¨åœ°å€
  return 'http://localhost:3001/api';
}

// ä»APIè·å–æœåŠ¡å™¨æ•°æ®
let servers = [];

try {
  const apiBaseUrl = getApiBaseUrl();
  const response = await fetch(`${apiBaseUrl}/servers`);
  const result = await response.json();
  
  if (result.success) {
    servers = result.data;
  } else {
    console.error('è·å–æœåŠ¡å™¨æ•°æ®å¤±è´¥:', result.message);
    servers = []; // ç¡®ä¿ä½¿ç”¨ç©ºæ•°ç»„è€Œä¸æ˜¯å¤‡ç”¨æ•°æ®
  }
} catch (error) {
  console.error('APIè¿æ¥å¤±è´¥:', error);
  servers = []; // ç¡®ä¿ä½¿ç”¨ç©ºæ•°ç»„è€Œä¸æ˜¯å¤‡ç”¨æ•°æ®
}

// è®¡ç®—ç»Ÿè®¡æ•°æ®
const totalServers = servers.length;

// è®¡ç®—å³å°†åˆ°æœŸçš„æœåŠ¡å™¨æ•°é‡ï¼ˆ30å¤©å†…ï¼‰
const expiringSoon = servers.filter(server => {
  // æ°¸ä¹…æœåŠ¡å™¨ä¸ä¼šè¿‡æœŸ
  if (server.renewalCycle === 'æ°¸ä¹…') {
    return false;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„åˆ°æœŸæ—¥æœŸ
  if (!server.expirationDate) {
    return false;
  }
  
  const expirationDate = new Date(server.expirationDate);
  const today = new Date();
  const thirtyDaysFromNow = new Date();
  thirtyDaysFromNow.setDate(today.getDate() + 30);
  
  return expirationDate <= thirtyDaysFromNow && expirationDate >= today;
}).length;

// è®¡ç®—å¯ç”¨æœåŠ¡å™¨æ•°é‡
const availableServers = servers.filter(server => server.status === 'å‡ºå”®').length;

// è®¡ç®—æ€»å‰©ä½™ä»·å€¼
const totalRemainingValue = servers.reduce((total, server) => {
  if (!server.remainingValue) {
    return total;
  }
  
  // å¤„ç†å„ç§æ ¼å¼çš„å‰©ä½™ä»·å€¼ (å¦‚: "100 CNY", "ï¿¥1,500.00", "0 CNY")
  let valueStr = server.remainingValue.toString();
  
  // ç§»é™¤è´§å¸ç¬¦å·å’Œå•ä½ï¼Œåªä¿ç•™æ•°å­—å’Œå°æ•°ç‚¹ã€é€—å·
  valueStr = valueStr.replace(/[ï¿¥$â‚¬Â£Â¥]/g, '').replace(/[A-Z]{3}/g, '').replace(/,/g, '').trim();
  
  const value = parseFloat(valueStr);
  return total + (isNaN(value) ? 0 : value);
}, 0);
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="generator" content={Astro.generator} />
	<title>B-Market</title>
	<meta name="description" content="ç®€çº¦çš„æœåŠ¡å™¨äº¤æ˜“è®°å½•å¹³å°ï¼Œè½»æ¾è®°å½•å’Œç®¡ç†æ‚¨çš„æœåŠ¡å™¨äº¤æ˜“ä¿¡æ¯ã€‚" />
	<link rel="stylesheet" href="/flag-icons.min.css" />
	
	<!-- å…¨å±€APIé…ç½® - Dockerå•å®¹å™¨åå‘ä»£ç†æ¨¡å¼ -->
	<script is:inline>
		window.API_CONFIG = {
			baseUrl: (() => {
				// Dockerå•å®¹å™¨æ¨¡å¼ï¼šå®¢æˆ·ç«¯é€šè¿‡åå‘ä»£ç†è®¿é—®API
				// å¼€å‘ç¯å¢ƒæ£€æµ‹
				if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
					// å¼€å‘ç¯å¢ƒç›´æ¥è®¿é—®APIç«¯å£
					return 'http://localhost:3001/api';
				}
				
				// ç”Ÿäº§ç¯å¢ƒï¼ˆDockerï¼‰ï¼šä½¿ç”¨åå‘ä»£ç†
				// æ‰€æœ‰APIè¯·æ±‚éƒ½é€šè¿‡å½“å‰åŸŸåçš„/apiè·¯å¾„
				return '/api';
			})()
		};
		console.log('ğŸ”— å®¢æˆ·ç«¯APIé…ç½®:', window.API_CONFIG.baseUrl);
	</script>
	
	<style>

		body {
			background: url('/background.svg') no-repeat center center fixed;
			background-size: cover;
			color: #1a1a1a;
			min-height: 100vh;
			padding-bottom: 45px; /* ä¸ºå›ºå®šè„šéƒ¨ç•™å‡ºç©ºé—´ */
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		.content {
			padding: 20px 0;
		}

		.cards-grid {
			display: grid;
			gap: 24px;
			align-items: start;
			opacity: 0;
			transition: opacity 0.3s ease;
			margin-bottom: 40px;
		}
		
		.cards-grid.initialized {
			opacity: 1;
		}

		/* è®¡ç®—å™¨å¼¹çª—æ ·å¼ - ç»Ÿä¸€åŠ¨ç”»ç³»ç»Ÿ */
		.calculator-modal {
			display: flex;
			align-items: center;
			justify-content: center;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0);
			backdrop-filter: blur(0px);
			-webkit-backdrop-filter: blur(0px);
			opacity: 0;
			visibility: hidden;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.calculator-modal.show {
			background: rgba(0, 0, 0, 0.5);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			opacity: 1;
			visibility: visible;
		}

		.calculator-modal-content {
			background: #ffffff;
			border-radius: 16px;
			padding: 32px;
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			border: 1px solid rgba(255, 255, 255, 0.3);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
		}

		/* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
		.calculator-modal-content::-webkit-scrollbar {
			display: none;
		}

		/* Firefox - éšè—æ»šåŠ¨æ¡ */
		.calculator-modal-content {
			scrollbar-width: none;
			-ms-overflow-style: none;
		}



		.calculator-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 32px;
		}

		.calculator-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
		}

		.calculator-close-btn {
			background: #ffffff;
			border: none;
			font-size: 1.25rem;
			cursor: pointer;
			color: #ef4444;
			padding: 8px;
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 10px;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
		}

		.calculator-close-btn:hover {
			color: #dc2626;
			background: #ffffff;
		}

		.calculator-form {
			display: flex;
			flex-direction: column;
			gap: 24px;
			width: 100%;
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			align-items: stretch;
			width: 100%;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			width: 100%;
			min-width: 0;
			height: auto;
		}

		.form-group.full-width {
			grid-column: 1 / -1;
		}

		.form-label {
			font-size: 0.875rem;
			font-weight: 600;
			color: #374151;
			margin-bottom: 8px;
			letter-spacing: 0.025em;
		}

		.form-input, .form-select {
			padding: 14px 16px;
			border: none;
			border-radius: 12px;
			font-size: 0.875rem;
			font-weight: 500;
			background: #ffffff;
			color: #374151;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
			border: 1px solid rgba(229, 231, 235, 0.3);
			height: 50px;
			min-height: 50px;
			box-sizing: border-box;
			width: 100%;
		}

		/* åªä¸ºéåªè¯»çš„è¾“å…¥æ¡†æ·»åŠ transition */
		/* éšè—æ‰€æœ‰selectå…ƒç´ çš„é»˜è®¤ç®­å¤´ */
		select {
			-webkit-appearance: none !important;
			-moz-appearance: none !important;
			appearance: none !important;
			background-image: none !important;
			background: transparent !important;
		}
		
		/* éšè—IEçš„é»˜è®¤ç®­å¤´ */
		select::-ms-expand {
			display: none !important;
		}
		
		/* é’ˆå¯¹Webkitæµè§ˆå™¨çš„ç‰¹æ®Šå¤„ç† */
		select::-webkit-appearance {
			-webkit-appearance: none !important;
		}
		
		/* é’ˆå¯¹Firefoxçš„ç‰¹æ®Šå¤„ç† */
		select::-moz-appearance {
			-moz-appearance: none !important;
		}
		
		/* ä»·æ ¼è¾“å…¥å®¹å™¨ä¸­çš„selectç‰¹æ®Šå¤„ç† */
		.price-input-container select {
			-webkit-appearance: none !important;
			-moz-appearance: none !important;
			appearance: none !important;
			background-image: none !important;
			background: transparent !important;
			border: none !important;
			outline: none !important;
			cursor: pointer !important;
		}
		
		.price-input-container select::-ms-expand {
			display: none !important;
		}
		
		.price-input-container select::-webkit-appearance {
			-webkit-appearance: none !important;
		}
		
		.price-input-container select::-moz-appearance {
			-moz-appearance: none !important;
		}

		.form-input:not([readonly]), .form-select {
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.form-input:not([readonly]):focus, .form-select:focus {
			border-color: rgba(59, 130, 246, 0.5);
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
		}
		
		/* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
		.custom-select {
			position: relative;
			display: block;
			width: 100%;
		}
		
		.custom-select-trigger {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 14px 16px;
			border: 1px solid rgba(229, 231, 235, 0.3);
			border-radius: 12px;
			font-size: 0.875rem;
			font-weight: 500;
			background: #ffffff;
			color: #374151;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
			height: 50px;
			min-height: 50px;
			box-sizing: border-box;
			width: 100%;
			cursor: pointer;
			outline: none;
		}
		
		.custom-select-trigger:hover {
			border-color: rgba(59, 130, 246, 0.3);
		}
		
		.custom-select-trigger:focus {
			border-color: rgba(59, 130, 246, 0.5);
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
		}

		.custom-select.open .custom-select-trigger {
			border-color: rgba(59, 130, 246, 0.5);
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
		}
		
		.custom-select-arrow {
			width: 16px;
			height: 16px;
			color: #6b7280;
			transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			flex-shrink: 0;
		}
		
		.custom-select.open .custom-select-arrow {
			transform: rotate(180deg);
		}
		
		.custom-select-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			z-index: 1000;
			background: #ffffff;
			border: 1px solid rgba(229, 231, 235, 0.3);
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
			margin-top: 4px;
			opacity: 0;
			visibility: hidden;
			transform: translateY(-4px);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		.custom-select.open .custom-select-dropdown {
			opacity: 1;
			visibility: visible;
			transform: translateY(0);
		}
		
		.custom-select-option {
			padding: 12px 16px;
			font-size: 0.875rem;
			color: #374151;
			cursor: pointer;
			transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
			border-bottom: 1px solid rgba(229, 231, 235, 0.2);
		}
		
		.custom-select-option:last-child {
			border-bottom: none;
		}
		
		.custom-select-option:hover {
			background: rgba(59, 130, 246, 0.05);
			color: #1d4ed8;
		}
		
		.custom-select-option.selected {
			background: rgba(59, 130, 246, 0.1);
			color: #1d4ed8;
			font-weight: 600;
		}
		
		.custom-select-option.selected:hover {
			background: rgba(156, 163, 175, 0.7);
		}
		
		/* ä¸‹æ‹‰æ¡†æ»šåŠ¨æ¡æ ·å¼ */
		.custom-select-dropdown {
			max-height: 200px;
			overflow-y: auto;
		}
		
		.custom-select-dropdown::-webkit-scrollbar {
			width: 6px;
		}
		
		.custom-select-dropdown::-webkit-scrollbar-track {
			background: rgba(243, 244, 246, 0.5);
			border-radius: 3px;
		}
		
		.custom-select-dropdown::-webkit-scrollbar-thumb {
			background: rgba(156, 163, 175, 0.5);
			border-radius: 3px;
		}
		
		.custom-select-dropdown::-webkit-scrollbar-thumb:hover {
			background: rgba(156, 163, 175, 0.7);
		}

		.form-input:focus, .form-select:focus {
			outline: none;
			background: #ffffff;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			border-color: rgba(229, 231, 235, 0.3);
		}

		.form-select {
			cursor: pointer;
			background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
			background-position: right 14px center;
			background-repeat: no-repeat;
			background-size: 16px;
			padding-right: 40px;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			max-width: 100%;
		}

				.price-input-container {
			position: relative;
			display: flex;
			align-items: stretch;
			background: #ffffff;
			border-radius: 12px;
			backdrop-filter: none;
			-webkit-backdrop-filter: none;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			border: 1px solid rgba(229, 231, 235, 0.3);
			min-height: 50px;
			width: 100%;
			box-sizing: border-box;
			height: 50px;
			overflow: visible;
		}

		.price-input-container:focus-within {
			background: #ffffff;
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
			border-color: rgba(59, 130, 246, 0.5);
		}

		.price-input-container input[type="number"] {
			flex: 1;
			border: none;
			background: transparent;
			padding: 0 90px 0 12px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #374151;
			outline: none;
			-webkit-appearance: none;
			-moz-appearance: textfield;
			height: 100%;
			min-height: 22px;
			align-self: stretch;
			box-sizing: border-box;
			width: 100%;
		}

		.price-input-container input::-webkit-outer-spin-button,
		.price-input-container input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		.price-input-container select {
			border: none;
			background: transparent;
			padding: 14px 24px 14px 8px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #374151;
			outline: none;
			cursor: pointer;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			width: 90px;
			flex-shrink: 0;
			height: 100%;
		}

		/* å¸ç§é€‰æ‹©å™¨æ ·å¼ - ç¡®ä¿å®Œå…¨åœ¨è¾“å…¥æ¡†å†…éƒ¨å³ä¾§ */
		.currency-select-wrapper {
			position: absolute;
			top: 1px;
			right: 1px;
			bottom: 1px;
			width: 80px;
			border-left: 1px solid rgba(229, 231, 235, 0.3);
			background: transparent;
			border-radius: 0 11px 11px 0;
			display: flex;
			align-items: stretch;
			z-index: 2;
		}



		.price-input-container .currency-select {
			border: none !important;
			background: transparent !important;
			min-height: auto !important;
			height: 100% !important;
			width: 100% !important;
			display: flex !important;
			align-items: stretch !important;
			position: relative !important;
		}

		.price-input-container .currency-select .custom-select-trigger {
			border: none !important;
			border-radius: 0 11px 11px 0 !important;
			box-shadow: none !important;
			background: transparent !important;
			padding: 0 20px 0 8px !important;
			font-size: 0.875rem !important;
			font-weight: 500 !important;
			color: #374151 !important;
			min-height: auto !important;
			height: 100% !important;
			display: flex !important;
			align-items: center !important;
			justify-content: space-between !important;
			position: relative !important;
			width: 100% !important;
			cursor: pointer !important;
			box-sizing: border-box !important;
		}

		.price-input-container .currency-select .custom-select-trigger:hover {
			background: rgba(249, 250, 251, 0.8) !important;
		}

		.price-input-container .currency-select .custom-select-dropdown {
			position: absolute !important;
			top: 100% !important;
			right: 0 !important;
			left: auto !important;
			width: 120px !important;
			z-index: 1001 !important;
			max-height: 200px !important;
			overflow-y: auto !important;
			background: #ffffff !important;
			border: 1px solid rgba(229, 231, 235, 0.3) !important;
			border-radius: 8px !important;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
			margin-top: 4px !important;
		}

		.price-input-container .currency-select .custom-select-text {
			flex: 1;
			text-align: left;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.price-input-container .currency-select .custom-select-arrow {
			position: absolute !important;
			right: 6px !important;
			top: 50% !important;
					transform: translateY(-50%) !important;
		transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
			width: 12px !important;
			height: 12px !important;
			color: #6b7280 !important;
			flex-shrink: 0 !important;
		}

		.price-input-container .currency-select.open .custom-select-arrow {
			transform: translateY(-50%) rotate(180deg) !important;
		}

		/* å¸ç§ä¸‹æ‹‰æ¡†æ»šåŠ¨æ¡æ ·å¼ */
		.price-input-container .currency-select .custom-select-dropdown::-webkit-scrollbar {
			width: 6px;
		}

		.price-input-container .currency-select .custom-select-dropdown::-webkit-scrollbar-track {
			background: rgba(243, 244, 246, 0.5);
			border-radius: 3px;
		}

		.price-input-container .currency-select .custom-select-dropdown::-webkit-scrollbar-thumb {
			background: rgba(156, 163, 175, 0.5);
			border-radius: 3px;
		}

		.price-input-container .currency-select .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
			background: rgba(156, 163, 175, 0.7);
		}

		/* ç¡®ä¿å¸ç§é€‰æ‹©å™¨é€‰é¡¹æ ·å¼æ­£ç¡® */
		.price-input-container .currency-select .custom-select-option {
			padding: 10px 16px !important;
			font-size: 0.875rem !important;
			color: #374151 !important;
			cursor: pointer !important;
			transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
			border: none !important;
			background: transparent !important;
		}

		.price-input-container .currency-select .custom-select-option:hover {
			background-color: rgba(243, 244, 246, 0.8) !important;
		}

		.price-input-container .currency-select .custom-select-option.selected {
			background-color: rgba(59, 130, 246, 0.1) !important;
			color: #1d4ed8 !important;
			font-weight: 500 !important;
		}

		/* ç¡®ä¿è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŸºç¡€æ ·å¼ */
		.custom-select {
			position: relative;
			display: block;
		}

		.custom-select.open .custom-select-dropdown {
			display: block;
		}

		.custom-select:not(.open) .custom-select-dropdown {
			display: none;
		}

		/* ç°ä»£åŒ–æ—¥å†å¼¹å‡ºæ¡†æ ·å¼ä¼˜åŒ– */
		.form-input[type="date"] {
			position: relative;
			color-scheme: light;
		}

		.form-input[type="date"]:focus {
			z-index: 10;
		}

		/* æ—¥å†å¼¹å‡ºæ¡†çš„ç°ä»£åŒ–æ ·å¼ - é€šè¿‡å…¨å±€CSSå˜é‡æ§åˆ¶ */
		:root {
			--calendar-bg: #ffffff;
			--calendar-border: rgba(229, 231, 235, 0.8);
			--calendar-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
			--calendar-header-bg: #f8fafc;
			--calendar-text: #374151;
			--calendar-accent: #3b82f6;
			--calendar-hover: #f1f5f9;
		}

		/* éšè—æ‰€æœ‰æ—¥å†å›¾æ ‡ - çº¯è¾“å…¥æ¡†æ¨¡å¼ */
		input[type="date"]::-webkit-calendar-picker-indicator,
		.form-input[type="date"]::-webkit-calendar-picker-indicator,
		#calcExpirationDate::-webkit-calendar-picker-indicator {
			display: none !important;
			-webkit-appearance: none !important;
			appearance: none !important;
			background: none !important;
			width: 0 !important;
			height: 0 !important;
			opacity: 0 !important;
			visibility: hidden !important;
		}
		
		/* éšè—Firefoxçš„æ—¥å†å›¾æ ‡ */
		input[type="date"]::-moz-calendar-picker-indicator,
		.form-input[type="date"]::-moz-calendar-picker-indicator,
		#calcExpirationDate::-moz-calendar-picker-indicator {
			display: none !important;
			-moz-appearance: none !important;
			background: none !important;
			width: 0 !important;
			height: 0 !important;
			opacity: 0 !important;
			visibility: hidden !important;
		}
		
		/* éšè—Edge/IEçš„æ—¥å†å›¾æ ‡ */
		input[type="date"]::-ms-clear,
		.form-input[type="date"]::-ms-clear,
		#calcExpirationDate::-ms-clear {
			display: none !important;
		}
		
		/* å¼ºåˆ¶ç§»é™¤æ‰€æœ‰æ—¥å†ç›¸å…³çš„æŒ‰é’®å’ŒæŒ‡ç¤ºå™¨ */
		input[type="date"],
		.form-input[type="date"],
		#calcExpirationDate {
			background-image: none !important;
		}
		
		input[type="date"]::-webkit-inner-spin-button,
		input[type="date"]::-webkit-outer-spin-button,
		.form-input[type="date"]::-webkit-inner-spin-button,
		.form-input[type="date"]::-webkit-outer-spin-button,
		#calcExpirationDate::-webkit-inner-spin-button,
		#calcExpirationDate::-webkit-outer-spin-button {
			-webkit-appearance: none !important;
			margin: 0 !important;
			display: none !important;
		}

		.form-input[readonly] {
			background: rgba(243, 244, 246, 0.8) !important;
			cursor: not-allowed !important;
			color: #6b7280 !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
		}
		
		.form-input[readonly]:focus {
			background: rgba(243, 244, 246, 0.8) !important;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
		}

		/* ç¡®ä¿åªè¯»è¾“å…¥æ¡†æ ·å¼ä¸è¢«ä»»ä½•å…¶ä»–è§„åˆ™è¦†ç›– */
		#calcRemainingValueDisplay[readonly] {
			background: rgba(243, 244, 246, 0.8) !important;
			cursor: not-allowed !important;
			color: #6b7280 !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
		}
		
		#calcRemainingValueDisplay[readonly]:focus {
			background: rgba(243, 244, 246, 0.8) !important;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
		}

		/* ç¡®ä¿è®¡ç®—è¯¦æƒ…åŒºåŸŸä¹Ÿæ²¡æœ‰transition */
		.calculation-details * {
			transition: none !important;
		}

		/* å¼ºåˆ¶ç¡®ä¿å‰©ä½™ä»·å€¼è¾“å…¥æ¡†å’Œè®¡ç®—è¯¦æƒ…æ¡†çš„æ ·å¼å®Œå…¨å›ºå®š */
		#calcRemainingValueDisplay {
			background: rgba(243, 244, 246, 0.8) !important;
			cursor: not-allowed !important;
			color: #6b7280 !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
			animation: none !important;
			transform: none !important;
		}

		/* ç¡®ä¿IDé€‰æ‹©å™¨çš„ä¼˜å…ˆçº§é«˜äºclassé€‰æ‹©å™¨ï¼Œä»ä¸€å¼€å§‹å°±åº”ç”¨æ­£ç¡®æ ·å¼ */
		#calcRemainingValueDisplay.form-input {
			background: rgba(243, 244, 246, 0.8) !important;
			cursor: not-allowed !important;
			color: #6b7280 !important;
			transition: none !important;
		}

		#calcRemainingValueDisplay:hover,
		#calcRemainingValueDisplay:focus,
		#calcRemainingValueDisplay:active {
			background: rgba(243, 244, 246, 0.8) !important;
			cursor: not-allowed !important;
			color: #6b7280 !important;
			border-color: rgba(229, 231, 235, 0.3) !important;
			transition: none !important;
			animation: none !important;
			transform: none !important;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
		}

		.calculation-details {
			background: rgba(248, 250, 252, 0.95) !important;
			border-radius: 12px !important;
			padding: 20px !important;
			backdrop-filter: none !important;
			-webkit-backdrop-filter: none !important;
			border: 1px solid rgba(226, 232, 240, 0.6) !important;
			margin-top: 8px !important;
			transition: none !important;
			animation: none !important;
			transform: none !important;
		}

		.calculation-details:hover,
		.calculation-details:focus,
		.calculation-details:active {
			background: rgba(248, 250, 252, 0.95) !important;
			transition: none !important;
			animation: none !important;
			transform: none !important;
		}

		/* é˜²æ­¢ä»»ä½•å…¨å±€æ ·å¼å½±å“è¿™ä¸¤ä¸ªå…³é”®å…ƒç´  */
		#calcRemainingValueDisplay,
		.calculation-details,
		.calculation-details div,
		.calculation-details span,
		.calculation-details strong {
			-webkit-transition: none !important;
			-moz-transition: none !important;
			-o-transition: none !important;
			transition: none !important;
			-webkit-animation: none !important;
			-moz-animation: none !important;
			-o-animation: none !important;
			animation: none !important;
			-webkit-transform: none !important;
			-moz-transform: none !important;
			-o-transform: none !important;
			transform: none !important;
		}

		.calculation-info {
			font-size: 0.8125rem;
			color: #475569;
			line-height: 1.6;
			font-weight: 500;
		}

		/* è®¡ç®—çŠ¶æ€æ ·å¼ç±» */
		.calc-pending {
			background: rgba(156, 163, 175, 0.1) !important;
			padding: 12px;
			border-radius: 8px;
			border-left: 4px solid #9ca3af;
		}

		.calc-success {
			background: rgba(16, 185, 129, 0.1) !important;
			padding: 12px;
			border-radius: 8px;
			border-left: 4px solid #10b981;
		}

		.calc-permanent {
			background: rgba(34, 197, 94, 0.1) !important;
			padding: 12px;
			border-radius: 8px;
			border-left: 4px solid #22c55e;
		}

		.calc-error {
			background: rgba(239, 68, 68, 0.1) !important;
			padding: 12px;
			border-radius: 8px;
			border-left: 4px solid #ef4444;
	}

	@media (min-width: 1200px) {
		.cards-grid {
				grid-template-columns: repeat(4, minmax(280px, 300px));
				justify-content: center;
		}
	}

	@media (min-width: 900px) and (max-width: 1199px) {
		.cards-grid {
				grid-template-columns: repeat(3, minmax(280px, 300px));
				justify-content: center;
		}
	}

	@media (min-width: 600px) and (max-width: 899px) {
		.cards-grid {
				grid-template-columns: repeat(2, minmax(280px, 320px));
				justify-content: center;
		}
	}

	@media (max-width: 599px) {
		.cards-grid {
			grid-template-columns: 1fr;
				justify-content: center;
				justify-items: center;
			gap: 16px;
		}

		.container {
			padding: 16px;
		}

		.content {
			padding: 16px 0;
		}
			
			body {
				padding-bottom: 50px; /* ç§»åŠ¨ç«¯ç¨å¾®å¢åŠ åº•éƒ¨ç©ºé—´ */
			}

			.calculator-modal-content {
				width: 95%;
				padding: 24px 20px;
				margin: 10px;
			}

			.form-row {
				grid-template-columns: 1fr;
				gap: 16px;
		}

		/* ç§»åŠ¨ç«¯å¸ç§é€‰æ‹©å™¨ä¼˜åŒ– */
		.currency-select-wrapper {
			width: 75px;
		}

		.price-input-container input[type="number"] {
			padding-right: 85px;
		}

		.price-input-container .currency-select .custom-select-trigger {
			padding: 0 18px 0 6px !important;
		}
	}
	
	@media (max-width: 480px) {
		.container {
			padding: 12px;
		}
			
			body {
				padding-bottom: 55px; /* å°å±å¹•æ›´å¤šåº•éƒ¨ç©ºé—´ */
		}
	}
	</style>
	
	<!-- å¼ºåˆ¶éšè—æ—¥å†å›¾æ ‡çš„ç»ˆæCSSè§„åˆ™ -->
	<style>
		/* æœ€é«˜ä¼˜å…ˆçº§ - å¼ºåˆ¶éšè—æ‰€æœ‰æ—¥å†å›¾æ ‡ */
		* input[type="date"]::-webkit-calendar-picker-indicator,
		* .form-input[type="date"]::-webkit-calendar-picker-indicator,
		* #calcExpirationDate::-webkit-calendar-picker-indicator,
		input[type="date"]::-webkit-calendar-picker-indicator,
		.form-input[type="date"]::-webkit-calendar-picker-indicator,
		#calcExpirationDate::-webkit-calendar-picker-indicator {
			display: none !important;
			-webkit-appearance: none !important;
			appearance: none !important;
			background: transparent !important;
			background-image: none !important;
			background-color: transparent !important;
			width: 0 !important;
			height: 0 !important;
			opacity: 0 !important;
			visibility: hidden !important;
			position: absolute !important;
			left: -9999px !important;
			pointer-events: none !important;
			margin: 0 !important;
			padding: 0 !important;
			border: none !important;
			outline: none !important;
			box-shadow: none !important;
		}
		
		/* Firefoxæ—¥å†å›¾æ ‡éšè— */
		* input[type="date"]::-moz-calendar-picker-indicator,
		* .form-input[type="date"]::-moz-calendar-picker-indicator,
		* #calcExpirationDate::-moz-calendar-picker-indicator {
			display: none !important;
			-moz-appearance: none !important;
			background: none !important;
			opacity: 0 !important;
			visibility: hidden !important;
		}
		
		/* ç¡®ä¿è¾“å…¥æ¡†æœ¬èº«æ²¡æœ‰èƒŒæ™¯å›¾åƒ */
		input[type="date"],
		.form-input[type="date"],
		#calcExpirationDate {
			background-image: none !important;
			background-position: unset !important;
			background-repeat: no-repeat !important;
			background-size: 0 !important;
		}
		
		/* å¼ºåˆ¶ç§»é™¤ä»»ä½•å¯èƒ½çš„æ—¥å†ç›¸å…³æ ·å¼ */
		input[type="date"]:before,
		input[type="date"]:after,
		.form-input[type="date"]:before,
		.form-input[type="date"]:after,
		#calcExpirationDate:before,
		#calcExpirationDate:after {
			display: none !important;
			content: none !important;
		}
		/* é¡µé¢æ·¡å…¥åŠ¨ç”» */
		.page-wrapper {
			animation: pageContentFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		@keyframes pageContentFadeIn {
			0% {
				opacity: 0;
				transform: translateY(16px);
			}
			40% {
				opacity: 0.6;
				transform: translateY(8px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* é¡µé¢åŠ è½½æ—¶çš„å†…å®¹æ¸ç°æ•ˆæœ */
		.container {
			animation: containerFadeIn 0.6s 0.1s cubic-bezier(0.4, 0, 0.2, 1) both;
		}
		
		@keyframes containerFadeIn {
			0% {
				opacity: 0;
				transform: translateY(8px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* å¤´éƒ¨å’Œå†…å®¹åˆ†å±‚åŠ¨ç”» */
		.header {
			animation: headerFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
		}
		
		@keyframes headerFadeIn {
			0% {
				opacity: 0;
				transform: translateY(-8px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		.main-content {
			animation: mainContentFadeIn 0.5s 0.15s cubic-bezier(0.4, 0, 0.2, 1) both;
		}
		
		@keyframes mainContentFadeIn {
			0% {
				opacity: 0;
				transform: translateY(12px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* æœåŠ¡å™¨å¡ç‰‡æ·¡å…¥åŠ¨ç”» */
		.server-card {
			animation: cardFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
			opacity: 0;
			transform: translateY(8px);
		}
		
		/* ä¸ºä¸åŒä½ç½®çš„å¡ç‰‡è®¾ç½®å»¶æ—¶åŠ¨ç”» */
		.server-card:nth-child(1) { animation-delay: 0s; }
		.server-card:nth-child(2) { animation-delay: 0.05s; }
		.server-card:nth-child(3) { animation-delay: 0.1s; }
		.server-card:nth-child(4) { animation-delay: 0.15s; }
		.server-card:nth-child(5) { animation-delay: 0.2s; }
		.server-card:nth-child(6) { animation-delay: 0.25s; }
		.server-card:nth-child(7) { animation-delay: 0.3s; }
		.server-card:nth-child(8) { animation-delay: 0.35s; }
		.server-card:nth-child(9) { animation-delay: 0.4s; }
		.server-card:nth-child(10) { animation-delay: 0.45s; }
		.server-card:nth-child(n+11) { animation-delay: 0.5s; }
		
		@keyframes cardFadeIn {
			0% {
				opacity: 0;
				transform: translateY(8px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* å¼¹çª—å†…å®¹åŠ¨ç”» */
		.calculator-modal-content {
			opacity: 0;
			transform: translateY(-12px) scale(0.95);
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		.calculator-modal.show .calculator-modal-content {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
		
		.calculator-modal.closing {
			background: rgba(0, 0, 0, 0) !important;
			backdrop-filter: blur(0px) !important;
			-webkit-backdrop-filter: blur(0px) !important;
			opacity: 0 !important;
			visibility: hidden !important;
		}
		
		.calculator-modal.closing .calculator-modal-content {
			opacity: 0;
			transform: translateY(-8px) scale(0.98);
		}
		
		/* æŒ‰é’®å’Œäº¤äº’å…ƒç´ åŠ¨ç”»ä¼˜åŒ– */
		button, .btn, .form-input, .custom-select-trigger {
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		button:hover, .btn:hover {
			transform: translateY(-1px);
		}
		
		button:active, .btn:active {
			transform: translateY(0);
		}
		
		/* ä¸‹æ‹‰æ¡†åŠ¨ç”»ä¼˜åŒ– */
		.custom-select-dropdown {
			opacity: 0;
			transform: translateY(-4px);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		.custom-select.open .custom-select-dropdown {
			opacity: 1;
			transform: translateY(0);
		}
		
		/* å“åº”å¼åŠ¨ç”»ä¼˜åŒ– */
		@media (prefers-reduced-motion: reduce) {
			*,
			*::before,
			*::after {
				animation-duration: 0.01ms !important;
				animation-iteration-count: 1 !important;
				transition-duration: 0.01ms !important;
				scroll-behavior: auto !important;
			}
		}
		
		/* å¹³æ»‘æ»šåŠ¨ */
		html {
			scroll-behavior: smooth;
		}
		
		/* é¡µé¢é€€å‡ºåŠ¨ç”» */
		body.page-exit {
			opacity: 0;
			transform: translateY(-8px);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}
	</style>
</head>
<body>
	<div class="page-wrapper">
		<div class="header">
			<Header client:load />
		</div>
		
		<main class="container">
			<section class="content main-content">
				<div class="cards-grid">
					{servers.map(server => (
						<ServerCard server={server} />
					))}
				</div>
			</section>
		</main>
	</div>

	<!-- å‰©ä½™ä»·å€¼è®¡ç®—å™¨å¼¹çª— -->
	<div class="calculator-modal" id="calculatorModal">
		<div class="calculator-modal-content">
			<div class="calculator-header">
				<h3 class="calculator-title">å‰©ä½™ä»·å€¼è®¡ç®—å™¨</h3>
				<button class="calculator-close-btn" onclick="closeCalculatorModal()">&times;</button>
			</div>
			
			<form class="calculator-form" id="calculatorForm">
				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="calcRenewalPrice">ç»­è´¹ä»·æ ¼ *</label>
						<div class="price-input-container">
							<input type="number" id="calcRenewalPriceAmount" placeholder="299" step="0.01" min="0" oninput="updateCalcRenewalPrice()" onchange="updateCalcRenewalPrice()">
							<div class="currency-select-wrapper">
								<div class="custom-select currency-select" id="calcRenewalPriceCurrencySelect">
									<div class="custom-select-trigger" tabindex="0">
										<span class="custom-select-text">CNY</span>
										<svg class="custom-select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
										</svg>
									</div>
									<div class="custom-select-dropdown">
										<div class="custom-select-option" data-value="">å¸ç§</div>
										<div class="custom-select-option" data-value="USD">USD</div>
										<div class="custom-select-option" data-value="EUR">EUR</div>
										<div class="custom-select-option" data-value="GBP">GBP</div>
										<div class="custom-select-option" data-value="JPY">JPY</div>
										<div class="custom-select-option selected" data-value="CNY">CNY</div>
										<div class="custom-select-option" data-value="KRW">KRW</div>
										<div class="custom-select-option" data-value="HKD">HKD</div>
										<div class="custom-select-option" data-value="SGD">SGD</div>
										<div class="custom-select-option" data-value="AUD">AUD</div>
										<div class="custom-select-option" data-value="CAD">CAD</div>
										<div class="custom-select-option" data-value="CHF">CHF</div>
										<div class="custom-select-option" data-value="SEK">SEK</div>
										<div class="custom-select-option" data-value="NOK">NOK</div>
										<div class="custom-select-option" data-value="DKK">DKK</div>
										<div class="custom-select-option" data-value="PLN">PLN</div>
										<div class="custom-select-option" data-value="CZK">CZK</div>
										<div class="custom-select-option" data-value="HUF">HUF</div>
										<div class="custom-select-option" data-value="RON">RON</div>
										<div class="custom-select-option" data-value="BGN">BGN</div>
										<div class="custom-select-option" data-value="RUB">RUB</div>
										<div class="custom-select-option" data-value="TRY">TRY</div>
										<div class="custom-select-option" data-value="BRL">BRL</div>
										<div class="custom-select-option" data-value="MXN">MXN</div>
										<div class="custom-select-option" data-value="ARS">ARS</div>
										<div class="custom-select-option" data-value="INR">INR</div>
										<div class="custom-select-option" data-value="THB">THB</div>
										<div class="custom-select-option" data-value="VND">VND</div>
										<div class="custom-select-option" data-value="IDR">IDR</div>
										<div class="custom-select-option" data-value="MYR">MYR</div>
										<div class="custom-select-option" data-value="PHP">PHP</div>
										<div class="custom-select-option" data-value="ZAR">ZAR</div>
										<div class="custom-select-option" data-value="EGP">EGP</div>
										<div class="custom-select-option" data-value="TWD">TWD</div>
										<div class="custom-select-option" data-value="NZD">NZD</div>
										<div class="custom-select-option" data-value="ILS">ILS</div>
										<div class="custom-select-option" data-value="SAR">SAR</div>
										<div class="custom-select-option" data-value="AED">AED</div>
										<div class="custom-select-option" data-value="QAR">QAR</div>
										<div class="custom-select-option" data-value="KWD">KWD</div>
										<div class="custom-select-option" data-value="BHD">BHD</div>
										<div class="custom-select-option" data-value="OMR">OMR</div>
									</div>
								</div>
							</div>
						</div>
						<input type="hidden" id="calcRenewalPrice">
						<input type="hidden" id="calcRenewalPriceCurrency" value="CNY">
					</div>
					
					<div class="form-group">
						<label class="form-label" for="calcRenewalCycle">ç»­è´¹å‘¨æœŸ *</label>
						<div class="custom-select" id="calcRenewalCycleSelect">
							<div class="custom-select-trigger" tabindex="0">
								<span class="custom-select-text">è¯·é€‰æ‹©å‘¨æœŸ</span>
								<svg class="custom-select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
								</svg>
							</div>
							<div class="custom-select-dropdown">
								<div class="custom-select-option selected" data-value="">è¯·é€‰æ‹©å‘¨æœŸ</div>
								<div class="custom-select-option" data-value="æœˆä»˜">æœˆä»˜</div>
								<div class="custom-select-option" data-value="å­£ä»˜">å­£ä»˜</div>
								<div class="custom-select-option" data-value="åŠå¹´ä»˜">åŠå¹´ä»˜</div>
								<div class="custom-select-option" data-value="å¹´ä»˜">å¹´ä»˜</div>
								<div class="custom-select-option" data-value="ä¸¤å¹´ä»˜">ä¸¤å¹´ä»˜</div>
								<div class="custom-select-option" data-value="ä¸‰å¹´ä»˜">ä¸‰å¹´ä»˜</div>
								<div class="custom-select-option" data-value="äº”å¹´ä»˜">äº”å¹´ä»˜</div>
								<div class="custom-select-option" data-value="æ°¸ä¹…">æ°¸ä¹…</div>
							</div>
						</div>
						<input type="hidden" id="calcRenewalCycle" name="calcRenewalCycle" value="">
					</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="calcExpirationDate">åˆ°æœŸæ—¥æœŸ *</label>
						<input type="text" id="calcExpirationDate" class="form-input" placeholder="YYYY-MM-DD (å¦‚ï¼š2025-12-31)" onchange="calculateRemainingValue()">
					</div>
					
					<div class="form-group">
						<label class="form-label" for="calcRemainingValue">å‰©ä½™ä»·å€¼ <span style="font-size: 0.75rem; color: #6b7280;">(è‡ªåŠ¨è®¡ç®—)</span></label>
						<input type="text" id="calcRemainingValueDisplay" class="form-input" placeholder="å°†è‡ªåŠ¨è®¡ç®—" readonly>
						<input type="hidden" id="calcRemainingValue">
					</div>
				</div>

				<!-- è®¡ç®—è¯¦æƒ…ä¿¡æ¯ -->
				<div class="form-group full-width">
					<label class="form-label">è®¡ç®—è¯¦æƒ…</label>
					<div class="calculation-details">
						<div id="calcRemainingValueInfo" class="calculation-info">è¯·å¡«å†™ç»­è´¹ä»·æ ¼ã€ç»­è´¹å‘¨æœŸå’Œåˆ°æœŸæ—¥æœŸå¼€å§‹è®¡ç®—</div>
					</div>
				</div>


			</form>
		</div>
	</div>



	<Footer client:load />

	<script is:inline>
		// æç®€ç‰ˆæœ¬ï¼šä»…å¤„ç†é¡µé¢æ˜¾ç¤ºï¼Œå®Œå…¨è‡ªç„¶å¸ƒå±€
		function initialize() {
			const cardsGrid = document.querySelector('.cards-grid');
			if (!cardsGrid) return;

			// æ˜¾ç¤ºå¡ç‰‡ç½‘æ ¼
			setTimeout(() => {
				cardsGrid.classList.add('initialized');
			}, 100);
		}

		// åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
		function initCalcCustomSelect() {
			// åˆå§‹åŒ–ç»­è´¹å‘¨æœŸä¸‹æ‹‰æ¡†
			const renewalCycleSelectId = 'calcRenewalCycleSelect';
			const renewalCycleSelect = document.getElementById(renewalCycleSelectId);
			if (renewalCycleSelect) {
				initSingleCustomSelect(renewalCycleSelectId, 'calcRenewalCycle', handleCalcRenewalCycleChange);
			}
			
			// åˆå§‹åŒ–å¸ç§ä¸‹æ‹‰æ¡†
			const currencySelectId = 'calcRenewalPriceCurrencySelect';
			const currencySelect = document.getElementById(currencySelectId);
			if (currencySelect) {
				initSingleCustomSelect(currencySelectId, 'calcRenewalPriceCurrency', updateCalcRenewalPrice);
			}
		}
		
		// åˆå§‹åŒ–å•ä¸ªè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
		function initSingleCustomSelect(selectId, hiddenInputId, changeHandler) {
			const select = document.getElementById(selectId);
			if (!select) return;
			
			const trigger = select.querySelector('.custom-select-trigger');
			const dropdown = select.querySelector('.custom-select-dropdown');
			const options = select.querySelectorAll('.custom-select-option');
			const hiddenInput = hiddenInputId ? document.getElementById(hiddenInputId) : null;
			
			// ç‚¹å‡»è§¦å‘å™¨åˆ‡æ¢ä¸‹æ‹‰æ¡†
			trigger.addEventListener('click', function() {
				closeCalcSelects();
				select.classList.toggle('open');
			});
			
			// é”®ç›˜å¯¼èˆªæ”¯æŒ
			trigger.addEventListener('keydown', function(e) {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					closeCalcSelects();
					select.classList.toggle('open');
				}
			});
			
			// é€‰é¡¹ç‚¹å‡»äº‹ä»¶
			options.forEach(option => {
				option.addEventListener('click', function() {
					const value = this.getAttribute('data-value');
					const text = this.textContent;
					
					// æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
					trigger.querySelector('.custom-select-text').textContent = text;
					
					// æ›´æ–°éšè—è¾“å…¥æ¡†å€¼
					if (hiddenInput) {
						hiddenInput.value = value;
					}
					
					// æ›´æ–°é€‰ä¸­çŠ¶æ€
					options.forEach(opt => opt.classList.remove('selected'));
					this.classList.add('selected');
					
					// å…³é—­ä¸‹æ‹‰æ¡†
					select.classList.remove('open');
					
					// è§¦å‘changeäº‹ä»¶
					if (changeHandler) {
						changeHandler();
					}
				});
			});
		}
		
		// å…³é—­æ‰€æœ‰ä¸‹æ‹‰æ¡†
		function closeCalcSelects() {
			document.querySelectorAll('.custom-select').forEach(select => {
				select.classList.remove('open');
			});
		}
		
		// ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
		document.addEventListener('click', function(e) {
			if (!e.target.closest('.custom-select')) {
				closeCalcSelects();
			}
		});

		// åˆå§‹åŒ–æ—¥æœŸè¾“å…¥æ¡†
		function initDateInput() {
			const dateInput = document.getElementById('calcExpirationDate');
			if (dateInput) {
				// æ·»åŠ è¾“å…¥æ ¼å¼åŒ–
				dateInput.addEventListener('input', function() {
					formatDateInput(this);
				});
				
				// æ·»åŠ å¤±ç„¦éªŒè¯
				dateInput.addEventListener('blur', function() {
					const value = this.value.trim();
					if (value && !validateDateFormat(value)) {
						this.style.borderColor = '#ef4444';
						this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
						// å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
					} else {
						this.style.borderColor = '';
						this.style.boxShadow = '';
					}
				});
				
				// æ·»åŠ è·ç„¦æ—¶æ¸…é™¤é”™è¯¯æ ·å¼
				dateInput.addEventListener('focus', function() {
					this.style.borderColor = '';
					this.style.boxShadow = '';
				});
			}
		}

		// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', function() {
				initialize();
				initCalcCustomSelect();
				initDateInput();
			});
		} else {
			initialize();
			initCalcCustomSelect();
			initDateInput();
		}

		// Astro é¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–
		document.addEventListener('astro:after-swap', initialize);

		// æ‰“å¼€è®¡ç®—å™¨å¼¹çª—
		function openCalculatorModal() {
			const modal = document.getElementById('calculatorModal');
			modal.classList.remove('closing');
			
			// ä½¿ç”¨requestAnimationFrameç¡®ä¿åŠ¨ç”»æµç•…
			requestAnimationFrame(() => {
				modal.classList.add('show');
			});
			
			// æ¸…ç©ºè¡¨å•
			document.getElementById('calculatorForm').reset();
			document.getElementById('calcRemainingValueDisplay').value = '';
			document.getElementById('calcRemainingValueInfo').innerHTML = 'è¯·å¡«å†™ç»­è´¹ä»·æ ¼ã€ç»­è´¹å‘¨æœŸå’Œåˆ°æœŸæ—¥æœŸå¼€å§‹è®¡ç®—';
			
			// é‡æ–°åˆå§‹åŒ–æ—¥æœŸè¾“å…¥æ¡†
			setTimeout(() => {
				initDateInput();
			}, 50);
		}

		// å…³é—­è®¡ç®—å™¨å¼¹çª—
		function closeCalculatorModal() {
			const modal = document.getElementById('calculatorModal');
			modal.classList.add('closing');
			
			// ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤æ˜¾ç¤ºç±»
			setTimeout(() => {
				modal.classList.remove('show', 'closing');
			}, 300);
		}

		// ç®€åŒ–çš„æ ·å¼ç¡®ä¿å‡½æ•° - åªåœ¨éœ€è¦æ—¶æ‰§è¡Œ
		function ensureFixedStyles() {
			const remainingValueDisplay = document.getElementById('calcRemainingValueDisplay');
			if (remainingValueDisplay) {
				// ç¡®ä¿readonlyå±æ€§å­˜åœ¨
				remainingValueDisplay.setAttribute('readonly', 'readonly');
			}
		}

		// é¡µé¢åŠ è½½åç¡®ä¿readonlyå±æ€§
		document.addEventListener('DOMContentLoaded', ensureFixedStyles);

		// å°†å‡½æ•°ç»‘å®šåˆ°å…¨å±€ä½œç”¨åŸŸ
		window.openCalculatorModal = openCalculatorModal;
		window.closeCalculatorModal = closeCalculatorModal;

		// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
		document.getElementById('calculatorModal').addEventListener('click', (e) => {
			if (e.target === e.currentTarget) {
				closeCalculatorModal();
			}
		});

		// éªŒè¯æ—¥æœŸæ ¼å¼
		function validateDateFormat(dateString) {
			// æ£€æŸ¥åŸºæœ¬æ ¼å¼ YYYY-MM-DD
			const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
			if (!dateRegex.test(dateString)) {
				return false;
			}
			
			// æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆæ—¥æœŸ
			const date = new Date(dateString);
			const [year, month, day] = dateString.split('-').map(Number);
			
			return date.getFullYear() === year &&
				   date.getMonth() === month - 1 &&
				   date.getDate() === day;
		}
		
		// æ ¼å¼åŒ–æ—¥æœŸè¾“å…¥
		function formatDateInput(input) {
			let value = input.value.replace(/[^\d-]/g, ''); // åªä¿ç•™æ•°å­—å’Œæ¨ªçº¿
			
			// è‡ªåŠ¨æ·»åŠ æ¨ªçº¿
			if (value.length >= 4 && value.indexOf('-') === -1) {
				value = value.slice(0, 4) + '-' + value.slice(4);
			}
			if (value.length >= 7 && value.lastIndexOf('-') === 4) {
				value = value.slice(0, 7) + '-' + value.slice(7);
			}
			
			// é™åˆ¶é•¿åº¦
			if (value.length > 10) {
				value = value.slice(0, 10);
			}
			
			input.value = value;
		}

		// æ›´æ–°ç»­è´¹ä»·æ ¼éšè—å­—æ®µ
		function updateCalcRenewalPrice() {
			const amount = document.getElementById('calcRenewalPriceAmount').value;
			const currencySelect = document.getElementById('calcRenewalPriceCurrencySelect');
			const selectedOption = currencySelect ? currencySelect.querySelector('.custom-select-option.selected') : null;
			const currency = selectedOption ? selectedOption.getAttribute('data-value') : '';
			
			if (amount && currency) {
				document.getElementById('calcRenewalPrice').value = `${amount} ${currency}`;
				calculateRemainingValue();
			} else {
				document.getElementById('calcRenewalPrice').value = '';
			}
		}
		
		// è·å–å¸ç§é€‰æ‹©å™¨çš„å€¼
		function getCalcCurrencyValue() {
			const currencySelect = document.getElementById('calcRenewalPriceCurrencySelect');
			const selectedOption = currencySelect ? currencySelect.querySelector('.custom-select-option.selected') : null;
			return selectedOption ? selectedOption.getAttribute('data-value') : '';
		}

		// å¤„ç†ç»­è´¹å‘¨æœŸå˜åŒ–
		function handleCalcRenewalCycleChange() {
			const renewalCycle = document.getElementById('calcRenewalCycle').value;
			const expirationDateInput = document.getElementById('calcExpirationDate');
			
			if (renewalCycle === 'æ°¸ä¹…') {
				// æ°¸ä¹…æœåŠ¡å™¨ï¼šç¦ç”¨åˆ°æœŸæ—¥æœŸè¾“å…¥
				expirationDateInput.disabled = true;
				expirationDateInput.value = '';
				expirationDateInput.style.background = 'rgba(156, 163, 175, 0.3)';
				expirationDateInput.style.cursor = 'not-allowed';
				expirationDateInput.placeholder = 'æ°¸ä¹…æœåŠ¡å™¨æ— åˆ°æœŸæ—¥æœŸ';
			} else {
				// éæ°¸ä¹…æœåŠ¡å™¨ï¼šå¯ç”¨åˆ°æœŸæ—¥æœŸè¾“å…¥
				expirationDateInput.disabled = false;
				expirationDateInput.style.background = '#ffffff';
				expirationDateInput.style.cursor = '';
				expirationDateInput.placeholder = '';
			}
			
			// é‡æ–°è®¡ç®—ä»·å€¼
			calculateRemainingValue();
		}

		// å°†å‡½æ•°ç»‘å®šåˆ°å…¨å±€ä½œç”¨åŸŸ
		window.updateCalcRenewalPrice = updateCalcRenewalPrice;
		window.handleCalcRenewalCycleChange = handleCalcRenewalCycleChange;

		// ä»ç®¡ç†é¡µé¢å¤åˆ¶çš„è®¡ç®—é€»è¾‘
		// è´§å¸ç¬¦å·æ˜ å°„è¡¨
		const currencySymbols = {
			'$': 'USD', 'â‚¬': 'EUR', 'Â£': 'GBP', 'Â¥': 'CNY', 'â‚¹': 'INR', 'â‚©': 'KRW', 'â‚½': 'RUB',
			'US$': 'USD', 'A$': 'AUD', 'C$': 'CAD', 'HK$': 'HKD', 'S$': 'SGD', 'NZ$': 'NZD'
		};

		// æ±‡ç‡ç¼“å­˜
		let exchangeRatesCache = {};

		// è·å–å½“å‰æ—¥æœŸå­—ç¬¦ä¸²
		function getCurrentDateString() {
			const today = new Date();
			return today.toISOString().split('T')[0];
		}

		// æ¸…é™¤è¿‡æœŸçš„æ±‡ç‡ç¼“å­˜
		function cleanExpiredCache() {
			const today = getCurrentDateString();
			const keysToDelete = [];
			
			for (const key in exchangeRatesCache) {
				if (!key.includes(today)) {
					keysToDelete.push(key);
				}
			}
			
			keysToDelete.forEach(key => {
				delete exchangeRatesCache[key];
			});
		}

		// ä»ä»·æ ¼å­—ç¬¦ä¸²ä¸­è¯†åˆ«è´§å¸
		function detectCurrency(priceString) {
			if (!priceString || typeof priceString !== 'string') {
				return { currency: 'CNY', amount: 0 };
			}
			
			const trimmed = priceString.trim();
			
			// æ–°æ ¼å¼ï¼šæ•°å­— + ç©ºæ ¼ + è´§å¸ä»£ç 
			const newFormatMatch = trimmed.match(/^([0-9,.]+)\s+([A-Z]{3})$/i);
			if (newFormatMatch) {
				const amount = parseFloat(newFormatMatch[1].replace(/[,]/g, ''));
				const currency = newFormatMatch[2].toUpperCase();
				return { currency, amount };
			}
			
			// é»˜è®¤å½“ä½œäººæ°‘å¸å¤„ç†
			const amount = parseFloat(trimmed.replace(/[,\sÂ¥]/g, '')) || 0;
			return { currency: 'CNY', amount };
		}

		// è·å–æ±‡ç‡
		async function getExchangeRates(baseCurrency = 'USD') {
			const today = getCurrentDateString();
			const cacheKey = `${baseCurrency}_${today}`;
			
			cleanExpiredCache();
			
			if (exchangeRatesCache[cacheKey]) {
				return exchangeRatesCache[cacheKey];
			}
			
			const apiUrl = `https://open.er-api.com/v6/latest/${baseCurrency}`;
			
			try {
				const response = await fetch(apiUrl);
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}
				
				const data = await response.json();
				
				if (!data.rates || typeof data.rates !== 'object') {
					throw new Error('æ±‡ç‡æ•°æ®æ ¼å¼é”™è¯¯');
				}
				
				const rates = { [baseCurrency]: 1, ...data.rates };
				
				const rateData = {
					rates: rates,
					baseCurrency: baseCurrency,
					date: today,
					timestamp: Date.now(),
					source: 'ExchangeRate-API',
					isRealTime: true,
					cacheKey: cacheKey
				};
				
				exchangeRatesCache[cacheKey] = rateData;
				
				return rateData;
			} catch (error) {
				throw new Error(`æ— æ³•è·å–${baseCurrency}åŸºå‡†æ±‡ç‡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•`);
			}
		}

		// è½¬æ¢æ±‡ç‡
		async function convertCurrency(amount, fromCurrency, toCurrency) {
			if (fromCurrency === toCurrency) {
				return amount;
			}
			
			try {
				const rateData = await getExchangeRates(fromCurrency);
				const rates = rateData.rates;
				
				if (!rates[toCurrency]) {
					throw new Error(`ä¸æ”¯æŒçš„è´§å¸è½¬æ¢: ${fromCurrency} -> ${toCurrency}`);
				}
				
				const convertedAmount = amount * rates[toCurrency];
				return convertedAmount;
			} catch (error) {
				throw error;
			}
		}

		// æ ¹æ®ç»­è´¹å‘¨æœŸè®¡ç®—æœˆæ•°
		function getCycleMonths(cycle) {
			const cycleMap = {
				'æœˆä»˜': 1, 'å­£ä»˜': 3, 'åŠå¹´ä»˜': 6, 'å¹´ä»˜': 12,
				'ä¸¤å¹´ä»˜': 24, 'ä¸‰å¹´ä»˜': 36, 'äº”å¹´ä»˜': 60, 'æ°¸ä¹…': 0
			};
			return cycleMap[cycle] || 0;
		}

		// æ¨ç®—è´­ä¹°æ—¥æœŸ
		function calculatePurchaseDate(expirationDate, renewalCycle) {
			if (!expirationDate || !renewalCycle || renewalCycle === 'æ°¸ä¹…') {
				return null;
			}
			
			const expDate = new Date(expirationDate);
			const months = getCycleMonths(renewalCycle);
			
			if (months === 0) return null;
			
			const purchaseDate = new Date(expDate);
			purchaseDate.setMonth(purchaseDate.getMonth() - months);
			
			return purchaseDate;
		}

		// è®¡ç®—å¤©æ•°å·®å¼‚
		function calculateDaysDifference(startDate, endDate) {
			const start = new Date(startDate);
			const end = new Date(endDate);
			
			const timeDiff = end.getTime() - start.getTime();
			const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
			
			return daysDiff;
		}

		// è®¡ç®—å‰©ä½™å¤©æ•°å æ¯”
		function calculateRemainingRatio(purchaseDate, expirationDate, today = new Date()) {
			if (!purchaseDate || !expirationDate) {
				return 0;
			}
			
			const totalDays = calculateDaysDifference(purchaseDate, expirationDate);
			const remainingDays = Math.max(0, calculateDaysDifference(today, expirationDate));
			
			if (totalDays <= 0) {
				return 0;
			}
			
			const ratio = remainingDays / totalDays;
			return Math.max(0, Math.min(1, ratio));
		}

		// è®¡ç®—å‰©ä½™ä»·å€¼
		async function calculateRemainingValue() {
			try {
				document.getElementById('calcRemainingValueDisplay').value = 'è®¡ç®—ä¸­...';
				document.getElementById('calcRemainingValueInfo').innerHTML = 'æ­£åœ¨è®¡ç®—ï¼Œè¯·ç¨å€™...';
				
				const renewalPriceString = document.getElementById('calcRenewalPrice').value;
				const { currency: renewalCurrency, amount: renewalPrice } = detectCurrency(renewalPriceString);
				const renewalCycle = document.getElementById('calcRenewalCycle').value;
				const expirationDate = document.getElementById('calcExpirationDate').value;
				
				// æ£€æŸ¥å¿…è¦å­—æ®µ
				if (renewalPrice === null || renewalPrice === undefined || renewalPrice === '' || !renewalCycle || 
					(renewalCycle !== 'æ°¸ä¹…' && !expirationDate)) {
					document.getElementById('calcRemainingValue').value = '';
					document.getElementById('calcRemainingValueDisplay').value = '';
					document.getElementById('calcRemainingValueInfo').innerHTML = `
						<div class="calc-pending">
							<strong style="color: #6b7280;">ğŸ“‹ å¾…è®¡ç®—</strong><br>
							<span style="color: #6b7280;">è¯·å¡«å†™ç»­è´¹ä»·æ ¼ã€ç»­è´¹å‘¨æœŸå’Œåˆ°æœŸæ—¥æœŸ</span>
						</div>
					`;
					return;
				}
				
				// æ£€æŸ¥æ˜¯å¦ä¸ºæ°¸ä¹…æœåŠ¡å™¨
				if (renewalCycle === 'æ°¸ä¹…') {
					const remainingValueOriginal = renewalPrice;
					
					let remainingValueCNY = 0;
					if (renewalPrice > 0) {
						remainingValueCNY = await convertCurrency(remainingValueOriginal, renewalCurrency, 'CNY');
					}
					
					if (renewalPrice === 0) {
						document.getElementById('calcRemainingValue').value = `0 ${renewalCurrency}`;
						document.getElementById('calcRemainingValueDisplay').value = `Â¥0.00`;
					} else {
						document.getElementById('calcRemainingValue').value = `${remainingValueOriginal} ${renewalCurrency}`;
						document.getElementById('calcRemainingValueDisplay').value = `Â¥${remainingValueCNY.toFixed(2)}`;
					}
					
					let renewalRateData = null;
					let renewalToCnyRate = 0;
					if (renewalPrice > 0) {
						renewalRateData = await getExchangeRates(renewalCurrency);
						renewalToCnyRate = renewalRateData.rates['CNY'];
					}
					
					const calculationDateStr = new Date().toLocaleDateString('zh-CN');
					const rateDate = renewalRateData ? renewalRateData.date || getCurrentDateString() : getCurrentDateString();
					
					let detailsHTML;
					if (renewalPrice === 0) {
						detailsHTML = `
							<div class="calc-permanent">
								<strong style="color: #16a34a;">ğŸ†“ æ°¸ä¹…å…è´¹æœåŠ¡å™¨</strong><br>
								<span style="color: #059669;">è®¡ç®—åŸºå‡†æ—¥æœŸ:</span> ${calculationDateStr}<br>
								<span style="color: #059669;">ç»­è´¹ä»·æ ¼:</span> ${renewalPrice} ${renewalCurrency} (å…è´¹)<br>
								<span style="color: #059669;">å‰©ä½™ä»·å€¼:</span> ${remainingValueOriginal} ${renewalCurrency} = Â¥0.00<br>
								<span style="color: #6b7280; font-size: 0.75rem;">æ°¸ä¹…å…è´¹æœåŠ¡å™¨æ— éœ€æ±‡ç‡è½¬æ¢</span>
							</div>
						`;
					} else {
						detailsHTML = `
							<div class="calc-permanent">
								<strong style="color: #16a34a;">ğŸ’ æ°¸ä¹…æœåŠ¡å™¨</strong><br>
								<span style="color: #059669;">è®¡ç®—åŸºå‡†æ—¥æœŸ:</span> ${calculationDateStr}<br>
								<span style="color: #059669;">ç»­è´¹ä»·æ ¼:</span> ${renewalPrice} ${renewalCurrency}<br>
								<span style="color: #059669;">å‰©ä½™ä»·å€¼:</span> ${remainingValueOriginal} ${renewalCurrency} â‰ˆ Â¥${remainingValueCNY.toFixed(2)}<br>
								<span style="color: #6b7280; font-size: 0.75rem;">æ±‡ç‡ (${rateDate}): 1 ${renewalCurrency} = Â¥${renewalToCnyRate.toFixed(4)}</span>
							</div>
						`;
					}
					
					document.getElementById('calcRemainingValueInfo').innerHTML = detailsHTML;
					return;
				}
				
				// æ¨ç®—è´­ä¹°æ—¥æœŸ
				const purchaseDate = calculatePurchaseDate(expirationDate, renewalCycle);
				
				if (!purchaseDate) {
					document.getElementById('calcRemainingValue').value = 'è®¡ç®—é”™è¯¯';
					document.getElementById('calcRemainingValueDisplay').value = 'è®¡ç®—é”™è¯¯';
					document.getElementById('calcRemainingValueInfo').innerHTML = 'æ— æ³•æ¨ç®—è´­ä¹°æ—¥æœŸï¼Œè¯·æ£€æŸ¥ç»­è´¹å‘¨æœŸè®¾ç½®';
					return;
				}
				
				// è®¡ç®—å‰©ä½™å¤©æ•°å æ¯”
				const calculationDate = new Date();
				calculationDate.setHours(0, 0, 0, 0);
				
				const remainingRatio = calculateRemainingRatio(purchaseDate, expirationDate, calculationDate);
				
				// è®¡ç®—å‰©ä½™ä»·å€¼
				const remainingValueOriginal = renewalPrice * remainingRatio;
				
				// è½¬æ¢ä¸ºäººæ°‘å¸
				const remainingValueCNY = await convertCurrency(remainingValueOriginal, renewalCurrency, 'CNY');
				
				// è®¡ç®—å¤©æ•°ä¿¡æ¯
				const totalDays = calculateDaysDifference(purchaseDate, expirationDate);
				const remainingDays = Math.max(0, calculateDaysDifference(calculationDate, expirationDate));
				const remainingPercentage = (remainingRatio * 100).toFixed(1);
				
				// è·å–æ±‡ç‡ä¿¡æ¯
				const renewalRateData = await getExchangeRates(renewalCurrency);
				const renewalToCnyRate = renewalRateData.rates['CNY'];
				
				// æ›´æ–°æ˜¾ç¤º
				document.getElementById('calcRemainingValue').value = `${remainingValueOriginal.toFixed(2)} ${renewalCurrency}`;
				document.getElementById('calcRemainingValueDisplay').value = `Â¥${remainingValueCNY.toFixed(2)}`;
				
				const purchaseDateStr = purchaseDate.toLocaleDateString('zh-CN');
				const expirationDateStr = new Date(expirationDate).toLocaleDateString('zh-CN');
				const calculationDateStr = calculationDate.toLocaleDateString('zh-CN');
				const rateDate = renewalRateData.date || getCurrentDateString();
				
				document.getElementById('calcRemainingValueInfo').innerHTML = `
					<div class="calc-success">
						<strong style="color: #059669;">ğŸ“Š å‰©ä½™ä»·å€¼è®¡ç®—</strong><br>
						<span style="color: #047857;">æ¨ç®—è´­ä¹°æ—¥æœŸ:</span> ${purchaseDateStr}<br>
						<span style="color: #047857;">åˆ°æœŸæ—¥æœŸ:</span> ${expirationDateStr}<br>
						<span style="color: #047857;">è®¡ç®—åŸºå‡†æ—¥æœŸ:</span> ${calculationDateStr}<br>
						<span style="color: #047857;">ç»­è´¹ä»·æ ¼:</span> ${renewalPrice} ${renewalCurrency}<br>
						<span style="color: #047857;">å‰©ä½™æ—¶é—´:</span> ${remainingDays}å¤© / æ€»è®¡${totalDays}å¤© (${remainingPercentage}%)<br>
						<span style="color: #047857;">å‰©ä½™ä»·å€¼:</span> ${remainingValueOriginal.toFixed(2)} ${renewalCurrency} â‰ˆ Â¥${remainingValueCNY.toFixed(2)}<br>
						<span style="color: #6b7280; font-size: 0.75rem;">æ±‡ç‡ (${rateDate}): 1 ${renewalCurrency} = Â¥${renewalToCnyRate.toFixed(4)}</span>
					</div>
				`;
				
			} catch (error) {
				console.error('è®¡ç®—å¤±è´¥:', error);
				let errorMessage = 'è®¡ç®—å¤±è´¥';
				
				if (error.message.includes('æ— æ³•è·å–')) {
					errorMessage = 'æ— æ³•è·å–æ±‡ç‡';
					document.getElementById('calcRemainingValueInfo').innerHTML = `
						<div class="calc-error">
							<strong style="color: #dc2626;">âš ï¸ æ±‡ç‡è·å–å¤±è´¥</strong><br>
							<span style="color: #b91c1c;">æ— æ³•è·å–å®æ—¶æ±‡ç‡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>
						</div>
					`;
				} else {
					document.getElementById('calcRemainingValueInfo').innerHTML = `
						<div class="calc-error">
							<strong style="color: #dc2626;">âŒ è®¡ç®—é”™è¯¯</strong><br>
							<span style="color: #b91c1c;">è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}</span>
						</div>
					`;
				}
				
				document.getElementById('calcRemainingValue').value = errorMessage;
				document.getElementById('calcRemainingValueDisplay').value = errorMessage;
			}
		}

		// å°†å‡½æ•°ç»‘å®šåˆ°å…¨å±€ä½œç”¨åŸŸ
		window.calculateRemainingValue = calculateRemainingValue;

		// ä»åç«¯APIè·å–æœ€æ–°çš„æœåŠ¡å™¨æ•°æ®å¹¶åŒæ­¥åˆ°é¦–é¡µ
		async function autoUpdateServerValues() {
			console.log('ğŸ”„ å¼€å§‹ä»åç«¯è·å–æœ€æ–°çš„æœåŠ¡å™¨æ•°æ®...');
			
			try {
				// ä»APIè·å–æœ€æ–°çš„æœåŠ¡å™¨æ•°æ®
				const response = await fetch(window.API_CONFIG.baseUrl + '/servers');
				if (!response.ok) {
					throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
				}
				
				const result = await response.json();
				if (!result.success || !result.data) {
					throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
				}
				
				const latestServers = result.data;
				console.log(`ğŸ“¡ è·å–åˆ° ${latestServers.length} ä¸ªæœåŠ¡å™¨çš„æœ€æ–°æ•°æ®`);
				
				// è·å–é¡µé¢ä¸Šçš„æ‰€æœ‰æœåŠ¡å™¨å¡ç‰‡
				const serverCards = document.querySelectorAll('.server-card');
				let updatedCount = 0;
				
				// ä¸ºæ¯ä¸ªæœåŠ¡å™¨å¡ç‰‡æ›´æ–°æ•°æ®
				serverCards.forEach((card) => {
					const serverId = card.dataset.serverId;
					if (!serverId) return;
					
					// æ ¹æ®IDæ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å™¨æ•°æ®
					const serverData = latestServers.find(server => server.id.toString() === serverId);
					if (!serverData) {
						console.warn(`âŒ æœªæ‰¾åˆ°IDä¸º ${serverId} çš„æœåŠ¡å™¨æ•°æ®`);
						return;
					}
					
					// è·³è¿‡å·²å”®æœåŠ¡å™¨ - å·²å”®æœåŠ¡å™¨çš„æ•°æ®åº”è¯¥ä¿æŒåœ¨å”®å‡ºæ—¶åˆ»çš„çŠ¶æ€
					if (serverData.status === 'å·²å”®') {
						console.log(`â­ï¸ è·³è¿‡å·²å”®æœåŠ¡å™¨ ${serverData.merchant}ï¼ˆæ•°æ®ä¿æŒåœ¨å”®å‡ºæ—¶åˆ»ï¼‰`);
						return;
					}
					
					let hasUpdates = false;
					
					// è·å–DOMå…ƒç´ 
					const remainingValueElement = card.querySelector('.remaining-value');
					const premiumValueElement = card.querySelector('.premium-value');
					
					// æ›´æ–°å‰©ä½™ä»·å€¼
					const newRemainingValue = serverData.remainingValue || '-';
					const oldRemainingValue = card.dataset.remainingValue;
					
					if (oldRemainingValue !== newRemainingValue) {
						// æ›´æ–°æ•°æ®å±æ€§
						card.dataset.remainingValue = newRemainingValue;
						
						// æ›´æ–°DOMæ˜¾ç¤ºï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
						if (remainingValueElement) {
							remainingValueElement.textContent = newRemainingValue;
							remainingValueElement.style.color = '#16a34a';
							remainingValueElement.style.fontWeight = '600';
							
							// çŸ­æš‚é«˜äº®æ˜¾ç¤ºæ›´æ–°
							remainingValueElement.style.transition = 'all 0.3s ease';
							setTimeout(() => {
								remainingValueElement.style.color = '';
								remainingValueElement.style.fontWeight = '';
							}, 2000);
						}
						
						hasUpdates = true;
						console.log(`âœ… æ›´æ–° ${serverData.merchant} å‰©ä½™ä»·å€¼: ${oldRemainingValue} -> ${newRemainingValue}`);
					}
					
					// æ›´æ–°æº¢ä»·ä¿¡æ¯
					const newPremiumValue = serverData.premiumValue || '-';
					const oldPremiumValue = card.dataset.premiumValue;
					
					if (oldPremiumValue !== newPremiumValue) {
						// æ›´æ–°æ•°æ®å±æ€§
						card.dataset.premiumValue = newPremiumValue;
						
						// æ›´æ–°DOMæ˜¾ç¤ºï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
						if (premiumValueElement) {
							premiumValueElement.textContent = newPremiumValue;
							
							// æ ¹æ®æº¢ä»·æ­£è´Ÿè®¾ç½®é¢œè‰²ï¼ˆåªå¯¹æœ‰æ•ˆæ•°å€¼è®¾ç½®é¢œè‰²ï¼‰
							if (newPremiumValue !== '-' && newPremiumValue !== '') {
								const premiumNum = parseFloat(newPremiumValue.replace('Â¥', '').replace(',', ''));
								if (!isNaN(premiumNum)) {
									if (premiumNum >= 0) {
										premiumValueElement.style.color = '#dc2626'; // çº¢è‰²è¡¨ç¤ºæº¢ä»·
									} else {
										premiumValueElement.style.color = '#16a34a'; // ç»¿è‰²è¡¨ç¤ºæŠ˜ä»·
									}
									premiumValueElement.style.fontWeight = '600';
								}
							}
							
							// çŸ­æš‚é«˜äº®æ˜¾ç¤ºæ›´æ–°
							premiumValueElement.style.transition = 'all 0.3s ease';
							setTimeout(() => {
								if (newPremiumValue === '-') {
									premiumValueElement.style.color = '';
									premiumValueElement.style.fontWeight = '';
								}
							}, 2000);
						}
						
						hasUpdates = true;
						console.log(`âœ… æ›´æ–° ${serverData.merchant} æº¢ä»·ä¿¡æ¯: ${oldPremiumValue} -> ${newPremiumValue}`);
					}
					
					// å¦‚æœæœ‰æ›´æ–°ï¼Œè®¡å…¥æ›´æ–°è®¡æ•°
					if (hasUpdates) {
						updatedCount++;
					}
				});
				
				
				// æ˜¾ç¤ºæ›´æ–°ç»“æœ
				if (updatedCount > 0) {
					console.log(`âœ… å·²åŒæ­¥æ›´æ–° ${updatedCount} ä¸ªæœåŠ¡å™¨çš„æœ€æ–°æ•°æ®`);
					
					// æ˜¾ç¤ºæ›´æ–°æç¤º
					const notification = document.createElement('div');
					notification.style.cssText = `
						position: fixed;
						top: 20px;
						right: 20px;
						background: linear-gradient(135deg, #16a34a, #15803d);
						color: white;
						padding: 12px 20px;
						border-radius: 8px;
						box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
						z-index: 10000;
						font-size: 14px;
						font-weight: 500;
						opacity: 0;
						transform: translateX(100%);
						transition: all 0.3s ease;
					`;
					notification.textContent = `ğŸ“¡ å·²åŒæ­¥ ${updatedCount} ä¸ªæœåŠ¡å™¨çš„æœ€æ–°æ•°æ®`;
					
					document.body.appendChild(notification);
					
					// æ˜¾ç¤ºåŠ¨ç”»
					setTimeout(() => {
						notification.style.opacity = '1';
						notification.style.transform = 'translateX(0)';
					}, 100);
					
					// è‡ªåŠ¨éšè—
					setTimeout(() => {
						notification.style.opacity = '0';
						notification.style.transform = 'translateX(100%)';
						setTimeout(() => notification.remove(), 300);
					}, 3000);
				} else {
					console.log('â„¹ï¸ æ‰€æœ‰æœåŠ¡å™¨æ•°æ®éƒ½æ˜¯æœ€æ–°çš„ï¼Œæ— éœ€æ›´æ–°');
				}
				
			} catch (error) {
				console.error('âŒ è·å–æœ€æ–°æœåŠ¡å™¨æ•°æ®å¤±è´¥:', error);
				
				// æ˜¾ç¤ºé”™è¯¯æç¤º
				const errorNotification = document.createElement('div');
				errorNotification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: linear-gradient(135deg, #dc2626, #b91c1c);
					color: white;
					padding: 12px 20px;
					border-radius: 8px;
					box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
					z-index: 10000;
					font-size: 14px;
					font-weight: 500;
					opacity: 0;
					transform: translateX(100%);
					transition: all 0.3s ease;
				`;
				errorNotification.textContent = `âŒ æ— æ³•è·å–æœ€æ–°æ•°æ®ï¼Œè¯·ç¨åé‡è¯•`;
				
				document.body.appendChild(errorNotification);
				
				// æ˜¾ç¤ºåŠ¨ç”»
				setTimeout(() => {
					errorNotification.style.opacity = '1';
					errorNotification.style.transform = 'translateX(0)';
				}, 100);
				
				// è‡ªåŠ¨éšè—
				setTimeout(() => {
					errorNotification.style.opacity = '0';
					errorNotification.style.transform = 'translateX(100%)';
					setTimeout(() => errorNotification.remove(), 300);
				}, 5000);
			}
		}
		
		// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ›´æ–°
		document.addEventListener('DOMContentLoaded', function() {
			// å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
			setTimeout(() => {
				autoUpdateServerValues();
			}, 1000);
		});
		
		// æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼ˆæ±‡ç‡å¯èƒ½ä¼šå˜åŒ–ï¼‰
		setInterval(autoUpdateServerValues, 60 * 60 * 1000);
	</script>
</body>
</html>
